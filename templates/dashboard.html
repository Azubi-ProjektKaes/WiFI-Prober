<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <title>WiFi Probing Station</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body {
      margin: 0;
      padding: 16px;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background-color: #111827;
      color: #e5e7eb;
    }

    h1 {
      margin-top: 0;
      margin-bottom: 4px;
    }

    #instance-info {
      margin-bottom: 10px;
      font-size: 0.9rem;
      opacity: 0.85;
    }

    .incident-banner {
      padding: 10px 14px;
      border-radius: 6px;
      margin-bottom: 12px;
      font-size: 0.9rem;
    }

    .incident-banner.warning {
      background-color: #fff3cd;
      color: #856404;
    }

    .incident-banner.critical {
      background-color: #f8d7da;
      color: #721c24;
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
      gap: 16px;
      margin-top: 12px;
    }

    .card {
      background-color: #1f2937;
      border-radius: 8px;
      padding: 12px 14px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.4);
    }

    .card h2 {
      font-size: 1.0rem;
      margin-top: 0;
      margin-bottom: 6px;
    }

    .metric {
      font-size: 1.4rem;
      font-weight: 600;
    }

    .metric-label {
      font-size: 0.85rem;
      opacity: 0.75;
    }

    .row {
      display: flex;
      justify-content: space-between;
      gap: 8px;
      font-size: 0.9rem;
      margin-top: 4px;
    }

    .badge-ok {
      color: #16a34a;
      font-weight: 600;
    }

    .badge-bad {
      color: #dc2626;
      font-weight: 600;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.8rem;
      margin-top: 6px;
    }

    th, td {
      text-align: left;
      padding: 4px 6px;
      border-bottom: 1px solid #374151;
    }

    th {
      background-color: #111827;
      position: sticky;
      top: 0;
      z-index: 1;
    }

    .scroll-table {
      max-height: 260px;
      overflow-y: auto;
    }
  </style>
</head>
<body>
  <h1>WiFi Probing Station</h1>
  <div id="instance-info">
    <span id="instance-host">Host: …</span> ·
    <span id="instance-ip">IP (wlan0): …</span>
  </div>

  <div id="incident-banner" style="display:none;" class="incident-banner">
    <strong id="incident-title"></strong>
    <div id="incident-details"></div>
  </div>

  <div class="grid">
    <div class="card">
      <h2>Live Ping</h2>
      <div class="row">
        <div>
          <div class="metric" id="ping-google">- ms</div>
          <div class="metric-label">Google (8.8.8.8)</div>
        </div>
        <div>
          <div class="metric" id="ping-cloudflare">- ms</div>
          <div class="metric-label">Cloudflare (1.1.1.1)</div>
        </div>
      </div>
    </div>

    <div class="card">
      <h2>System-Status</h2>
      <div class="row">
        <span>CPU</span><span id="sys-cpu">- %</span>
      </div>
      <div class="row">
        <span>RAM</span><span id="sys-ram">- %</span>
      </div>
      <div class="row">
        <span>Disk</span><span id="sys-disk">- %</span>
      </div>
      <div class="row">
        <span>Temp</span><span id="sys-temp">- °C</span>
      </div>
    </div>

    <div class="card">
      <h2>Statistik (24h)</h2>
      <div class="row">
        <span>Probes</span><span id="stat-probes-24h">-</span>
      </div>
      <div class="row">
        <span>Ø WiFi-Netze</span><span id="stat-avg-wifi">-</span>
      </div>
      <div class="row">
        <span>Ø Download</span><span id="stat-avg-speed">-</span>
      </div>
      <div class="row">
        <span>Letzter Probe</span><span id="stat-last-probe">-</span>
      </div>
    </div>

    <div class="card">
      <h2>WiFi-Netze (24h)</h2>
      <div class="scroll-table">
        <table>
          <thead>
          <tr>
            <th>SSID</th>
            <th>Signal</th>
            <th>Verschl.</th>
            <th>Seen</th>
          </tr>
          </thead>
          <tbody id="wifi-table-body">
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <script>
    async function fetchJson(url) {
      const res = await fetch(url);
      if (!res.ok) throw new Error("HTTP " + res.status);
      return res.json();
    }

    function updatePingCard(data) {
      const g = data.ping.google;
      const c = data.ping.cloudflare;
      const elG = document.getElementById('ping-google');
      const elC = document.getElementById('ping-cloudflare');

      if (g.success) {
        elG.innerText = g.avg_ms.toFixed(1) + " ms";
        elG.className = g.avg_ms < 50 ? "badge-ok" : "badge-bad";
      } else {
        elG.innerText = "Timeout";
        elG.className = "badge-bad";
      }

      if (c.success) {
        elC.innerText = c.avg_ms.toFixed(1) + " ms";
        elC.className = c.avg_ms < 50 ? "badge-ok" : "badge-bad";
      } else {
        elC.innerText = "Timeout";
        elC.className = "badge-bad";
      }
    }

    function updateSystemCard(data) {
      document.getElementById('sys-cpu').innerText = data.system.cpu.toFixed(0) + " %";
      document.getElementById('sys-ram').innerText = data.system.ram.toFixed(0) + " %";
      document.getElementById('sys-disk').innerText = data.system.disk.toFixed(0) + " %";
      document.getElementById('sys-temp').innerText = data.system.temp.toFixed(1) + " °C";
    }

    function updateMeta(data) {
      if (data.meta) {
        document.getElementById('instance-host').innerText = "Host: " + (data.meta.hostname || "unbekannt");
        document.getElementById('instance-ip').innerText = "IP (wlan0): " + (data.meta.wlan_ip || "unbekannt");
      }
    }

    function updateIncident(data) {
      const banner = document.getElementById('incident-banner');
      if (data.incident && data.incident.active) {
        banner.style.display = "block";
        banner.classList.remove("warning", "critical");
        banner.classList.add(data.incident.severity || "critical");
        document.getElementById('incident-title').innerText =
          "Ausfall erkannt (" + (data.incident.type || "unbekannt") + ")";
        document.getElementById('incident-details').innerText =
          "Seit: " + (data.incident.since || "unbekannt") +
          " · Details: " + (data.incident.message || "keine Details");
      } else {
        banner.style.display = "none";
      }
    }

    async function pollLive() {
      try {
        const data = await fetchJson('/api/ping_multi');
        updatePingCard(data);
        updateSystemCard(data);
        updateMeta(data);
        updateIncident(data);
      } catch (e) {
        console.error("Fehler beim Laden von /api/ping_multi", e);
      }
      setTimeout(pollLive, 1000);
    }

    async function pollStats() {
      try {
        const data = await fetchJson('/api/stats');
        if (Object.keys(data).length > 0) {
          document.getElementById('stat-probes-24h').innerText = data.probes_24h;
          document.getElementById('stat-avg-wifi').innerText = data.avg_wifi_networks;
          document.getElementById('stat-avg-speed').innerText = data.avg_download_speed + " Mbps";
          document.getElementById('stat-last-probe').innerText = data.last_probe;
        }
      } catch (e) {
        console.error("Fehler beim Laden von /api/stats", e);
      }
      setTimeout(pollStats, 15000);
    }

    async function pollNetworks() {
      try {
        const data = await fetchJson('/api/networks');
        const tbody = document.getElementById('wifi-table-body');
        tbody.innerHTML = "";
        (data.networks || []).forEach(net => {
          const tr = document.createElement('tr');
          tr.innerHTML =
            "<td>" + net.ssid + "</td>" +
            "<td>" + net.max_signal + " dBm</td>" +
            "<td>" + net.encryption + "</td>" +
            "<td>" + net.count + "x</td>";
          tbody.appendChild(tr);
        });
      } catch (e) {
        console.error("Fehler beim Laden von /api/networks", e);
      }
      setTimeout(pollNetworks, 30000);
    }

    pollLive();
    pollStats();
    pollNetworks();
  </script>
</body>
</html>
