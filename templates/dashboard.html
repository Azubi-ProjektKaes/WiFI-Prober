<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WiFi Probing Station</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --bg-color: #121212;
            --card-bg: #1e1e1e;
            --text-main: #e0e0e0;
            --text-muted: #a0a0a0;
            --accent: #bb86fc;
            --success: #03dac6;
            --error: #cf6679;
            --grid-line: #333;
        }
        body {
            font-family: Segoe UI, Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-main);
            margin: 0;
            padding: 20px;
        }
        .container { max-width: 1200px; margin: 0 auto; }
        h1 { text-align: center; margin-bottom: 5px; color: var(--accent); }
        .instance-info {
            text-align: center;
            font-size: 0.9rem;
            color: var(--text-muted);
            margin-bottom: 25px;
            opacity: 0.8;
        }
        .incident-banner {
            display: none;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 8px;
            text-align: center;
            font-weight: bold;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
            animation: fadeIn 0.5s;
        }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .incident-banner.warning { background-color: #ffb74d; color: #5d4037; }
        .incident-banner.critical { background-color: var(--error); color: #fff; }
        .incident-details { font-weight: normal; font-size: 0.9em; margin-top: 5px; opacity: 0.9; }
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        .card {
            background-color: var(--card-bg);
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
        }
        .card h2 {
            margin-top: 0;
            font-size: 1.2rem;
            border-bottom: 1px solid var(--grid-line);
            padding-bottom: 10px;
            margin-bottom: 15px;
            color: var(--text-muted);
        }
        .metric-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        .metric-value { font-size: 1.5rem; font-weight: bold; }
        .metric-label { color: var(--text-muted); font-size: 0.9rem; }
        .status-badge { padding: 4px 8px; border-radius: 4px; font-size: 0.8rem; font-weight: bold; }
        .status-ok { background-color: rgba(3,218,198,0.2); color: var(--success); }
        .status-bad { background-color: rgba(207,102,121,0.2); color: var(--error); }
        .table-container { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
        th, td { text-align: left; padding: 10px; border-bottom: 1px solid var(--grid-line); }
        th { color: var(--text-muted); }
        .chart-container { position: relative; height: 250px; width: 100%; }
        .scan-btn {
            background-color: var(--accent);
            color: #fff;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1rem;
            width: 100%;
            margin-top: 10px;
            transition: background-color 0.2s;
        }
        .scan-btn:hover { background-color: #9f67e0; }
        .scan-btn:disabled { background-color: var(--grid-line); cursor: not-allowed; }
        #loading-overlay {
            display: none;
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            flex-direction: column;
        }
        .spinner {
            border: 4px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top: 4px solid var(--accent);
            width: 40px; height: 40px;
            animation: spin 1s linear infinite;
            margin-bottom: 15px;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>
<div class="container">
    <h1>WiFi Probing Station</h1>

    <div class="instance-info">
        <span id="instance-host">Host: ...</span> &bull; <span id="instance-ip">IP wlan0: ...</span>
    </div>

    <div id="incident-banner" class="incident-banner">
        <div id="incident-title">Ausfall erkannt</div>
        <div id="incident-details" class="incident-details">...</div>
    </div>

    <div class="grid">
        <div class="card">
            <h2>Live Status</h2>
            <div class="metric-row">
                <span class="metric-label">Ping Google (8.8.8.8)</span>
                <span id="ping-google" class="status-badge status-ok">... ms</span>
            </div>
            <div class="metric-row">
                <span class="metric-label">Ping Cloudflare (1.1.1.1)</span>
                <span id="ping-cloudflare" class="status-badge status-ok">... ms</span>
            </div>
            <hr style="border-color: var(--grid-line); opacity: 0.3; margin: 15px 0;">
            <div class="metric-row">
                <span class="metric-label">CPU Auslastung</span>
                <span id="sys-cpu" class="metric-value">0%</span>
            </div>
            <div class="metric-row">
                <span class="metric-label">RAM Nutzung</span>
                <span id="sys-ram" class="metric-value">0%</span>
            </div>
            <div class="metric-row">
                <span class="metric-label">Temperatur</span>
                <span id="sys-temp" class="metric-value">0°C</span>
            </div>
        </div>

        <div class="card">
            <h2>Statistik 24h</h2>
            <div class="metric-row">
                <span class="metric-label">Messungen gesamt</span>
                <span id="stat-probes" class="metric-value">0</span>
            </div>
            <div class="metric-row">
                <span class="metric-label">Ø WLAN-Netzwerke</span>
                <span id="stat-avg-wifi" class="metric-value">0</span>
            </div>
            <div class="metric-row">
                <span class="metric-label">Ø Download Speed</span>
                <span id="stat-avg-speed" class="metric-value">0 Mbps</span>
            </div>
            <div class="metric-row">
                <span class="metric-label">Letzter Scan</span>
                <span id="stat-last" style="font-size: 0.9rem">nie</span>
            </div>
            <button id="btn-scan" class="scan-btn" onclick="triggerScan()">Jetzt Scannen</button>
        </div>
    </div>

    <div class="grid">
        <div class="card">
            <h2>Internet Speed 24h</h2>
            <div class="chart-container">
                <canvas id="chartSpeed"></canvas>
            </div>
        </div>
        <div class="card">
            <h2>Ping Latenz 24h</h2>
            <div class="chart-container">
                <canvas id="chartPing"></canvas>
            </div>
        </div>
    </div>

    <div class="card" style="margin-bottom: 20px;">
        <h2>Gefundene Netzwerke 24h</h2>
        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th>SSID</th>
                        <th>Max Signal</th>
                        <th>Verschlüsselung</th>
                        <th>Gesehen</th>
                        <th>Zuletzt</th>
                    </tr>
                </thead>
                <tbody id="wifi-table-body"></tbody>
            </table>
        </div>
    </div>

    <div class="card">
        <h2>Ausfall-Verlauf</h2>
        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th>Beginn</th>
                        <th>Ende</th>
                        <th>Dauer</th>
                        <th>Meldung</th>
                    </tr>
                </thead>
                <tbody id="outage-table-body">
                    <tr>
                        <td colspan="4" style="color: var(--text-muted); text-align: center;">Keine Ausfälle aufgezeichnet</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<div id="loading-overlay">
    <div class="spinner"></div>
    <div style="color: white; font-weight: bold;">Scan läuft... Bitte warten (~60s)</div>
</div>

<script>
    Chart.defaults.color = '#a0a0a0';
    Chart.defaults.borderColor = '#333';

    const chartSpeedCtx = document.getElementById('chartSpeed').getContext('2d');
    const chartPingCtx = document.getElementById('chartPing').getContext('2d');

    let chartSpeed = new Chart(chartSpeedCtx, {
        type: 'line',
        data: { labels: [], datasets: [] },
        options: { maintainAspectRatio: false, scales: { y: { beginAtZero: true } } }
    });
    let chartPing = new Chart(chartPingCtx, {
        type: 'line',
        data: { labels: [], datasets: [] },
        options: { maintainAspectRatio: false, scales: { y: { beginAtZero: true } } }
    });

    function formatDate(isoString) {
        if (!isoString) return '-';
        return new Date(isoString).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
    }

    function formatFullDate(isoString) {
        if (!isoString) return '-';
        return new Date(isoString).toLocaleString([], { day: '2-digit', month: '2-digit', hour: '2-digit', minute: '2-digit' });
    }

    function formatDuration(seconds) {
        if (seconds < 60) return `${seconds}s`;
        const m = Math.floor(seconds / 60);
        const s = seconds % 60;
        return `${m}m ${s}s`;
    }

    async function updateLive() {
        try {
            const res = await fetch('/api/ping_multi');
            const data = await res.json();

            if (data.meta) {
                document.getElementById('instance-host').innerText = 'Host: ' + (data.meta.hostname || 'Unbekannt');
                document.getElementById('instance-ip').innerText = 'IP wlan0: ' + (data.meta.wlan_ip || 'Unbekannt');
            }

            const banner = document.getElementById('incident-banner');
            if (data.incident && data.incident.active) {
                banner.style.display = 'block';
                banner.classList.remove('warning', 'critical');
                banner.classList.add(data.incident.severity || 'critical');
                document.getElementById('incident-title').innerText = '⚠ Ausfall: ' + (data.incident.type || 'Unbekannt');
                document.getElementById('incident-details').innerText = 'Seit: ' + formatFullDate(data.incident.since) + ' — ' + data.incident.message;
            } else {
                banner.style.display = 'none';
            }

            const pg = data.ping.google;
            const elPg = document.getElementById('ping-google');
            if (pg.success) {
                elPg.innerText = pg.avg_ms.toFixed(1) + ' ms';
                elPg.className = pg.avg_ms < 50 ? 'status-badge status-ok' : 'status-badge status-bad';
            } else {
                elPg.innerText = 'Timeout';
                elPg.className = 'status-badge status-bad';
            }

            const pc = data.ping.cloudflare;
            const elPc = document.getElementById('ping-cloudflare');
            if (pc.success) {
                elPc.innerText = pc.avg_ms.toFixed(1) + ' ms';
                elPc.className = pc.avg_ms < 50 ? 'status-badge status-ok' : 'status-badge status-bad';
            } else {
                elPc.innerText = 'Timeout';
                elPc.className = 'status-badge status-bad';
            }

            document.getElementById('sys-cpu').innerText = data.system.cpu.toFixed(0) + '%';
            document.getElementById('sys-ram').innerText = data.system.ram.toFixed(0) + '%';
            document.getElementById('sys-temp').innerText = data.system.temp.toFixed(1) + '°C';
        } catch(e) {
            console.error('Live update error', e);
        }
    }

    async function updateStats() {
        try {
            const res = await fetch('/api/stats');
            const data = await res.json();
            if (Object.keys(data).length === 0) return;
            document.getElementById('stat-probes').innerText = data.probes_24h;
            document.getElementById('stat-avg-wifi').innerText = data.avg_wifi_networks;
            document.getElementById('stat-avg-speed').innerText = data.avg_download_speed + ' Mbps';
            document.getElementById('stat-last').innerText = formatFullDate(data.last_probe);
        } catch(e) {
            console.error('Stats error', e);
        }
    }

    async function updateNetworks() {
        try {
            const res = await fetch('/api/networks');
            const data = await res.json();
            const tbody = document.getElementById('wifi-table-body');
            tbody.innerHTML = '';
            data.networks.sort((a, b) => b.max_signal - a.max_signal).forEach(net => {
                const tr = document.createElement('tr');
                tr.innerHTML = `<td><strong>${net.ssid}</strong></td><td>${net.max_signal} dBm</td><td>${net.encryption}</td><td>${net.count}x</td><td>${formatDate(net.last_seen)}</td>`;
                tbody.appendChild(tr);
            });
        } catch(e) {
            console.error('Networks error', e);
        }
    }

    async function updateOutages() {
        try {
            const res = await fetch('/api/outages');
            const data = await res.json();
            const tbody = document.getElementById('outage-table-body');
            if (!data.outages || data.outages.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" style="color: var(--text-muted); text-align: center;">Keine Ausfälle aufgezeichnet</td></tr>';
                return;
            }
            tbody.innerHTML = '';
            data.outages.forEach(o => {
                const tr = document.createElement('tr');
                tr.innerHTML = `<td>${formatFullDate(o.start)}</td><td>${formatFullDate(o.end)}</td><td>${formatDuration(o.duration_s)}</td><td style="color: var(--text-muted)">${o.message}</td>`;
                tbody.appendChild(tr);
            });
        } catch(e) {
            console.error('Outages error', e);
        }
    }

    async function updateCharts() {
        try {
            const res = await fetch('/api/chart/speedtest/24');
            const data = await res.json();
            chartSpeed.data.labels = data.timestamps.map(formatDate);
            chartSpeed.data.datasets = [
                { label: 'Download Mbps', data: data.downloads, borderColor: '#03dac6', tension: 0.3 },
                { label: 'Upload Mbps', data: data.uploads, borderColor: '#bb86fc', tension: 0.3 }
            ];
            chartSpeed.update();
        } catch(e) {}
        try {
            const res = await fetch('/api/chart/ping/24');
            const data = await res.json();
            chartPing.data.labels = data.timestamps.map(formatDate);
            chartPing.data.datasets = [
                { label: 'Google ms', data: data.google, borderColor: '#cf6679', tension: 0.1 },
                { label: 'Cloudflare ms', data: data.cloudflare, borderColor: '#ffb74d', tension: 0.1 }
            ];
            chartPing.update();
        } catch(e) {}
    }

    async function triggerScan() {
        const btn = document.getElementById('btn-scan');
        const overlay = document.getElementById('loading-overlay');
        if (!confirm('Einen neuen Scan jetzt starten? Das dauert ca. 60 Sekunden.')) return;
        btn.disabled = true;
        overlay.style.display = 'flex';
        try {
            const res = await fetch('/api/scan/trigger', { method: 'POST' });
            const data = await res.json();
            if (data.status === 'started') {
                const checkInterval = setInterval(async () => {
                    const sRes = await fetch('/api/scan/status');
                    const sData = await sRes.json();
                    if (!sData.scanning) {
                        clearInterval(checkInterval);
                        overlay.style.display = 'none';
                        btn.disabled = false;
                        alert('Scan abgeschlossen!');
                        updateStats();
                        updateNetworks();
                        updateCharts();
                    }
                }, 2000);
            } else {
                alert('Konnte Scan nicht starten: ' + data.message);
                overlay.style.display = 'none';
                btn.disabled = false;
            }
        } catch(e) {
            alert('Fehler beim Starten des Scans');
            overlay.style.display = 'none';
            btn.disabled = false;
        }
    }

    setInterval(updateLive, 1000);
    setInterval(updateStats, 30000);
    setInterval(updateNetworks, 60000);
    setInterval(updateCharts, 60000);
    setInterval(updateOutages, 30000);

    updateLive();
    updateStats();
    updateNetworks();
    updateCharts();
    updateOutages();
</script>
</body>
</html>
